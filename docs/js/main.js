import{CANVAS_WIDTH,CANVAS_HEIGHT,CLUSTERS_MAX,TIMEOUT_BG}from"./info.js";import{createBoard}from"./board.js";import{createClusters}from"./clusters.js";import{createPlayers}from"./players.js";import{drawInit,drawDices,drawDicesNums,drawDicesBar,drawCluster}from"./draw.js";let canvas,btn,listenerDisabled=!0,clusters,players,human,playerIndex=-1;function main(){setup(),nextTurn(players[0])}function setup(){(btn=document.getElementById("end-turn")).addEventListener("click",async()=>{listenerDisabled=!0,btn.disabled=!0,void 0!==human.clickedCluster&&drawCluster(human.clickedCluster.corners,human.id),await afterTurn(human)}),btn.disabled=!0;var a=document.getElementById("stage");for(let e=0;e<=CLUSTERS_MAX;e++)(canvas=document.createElement("canvas")).id="canvas-"+e,canvas.width=CANVAS_WIDTH,canvas.height=CANVAS_HEIGHT,0===e&&(canvas.style.background="#eee"),a.appendChild(canvas);canvas.addEventListener("click",clickListener,!1);var[e,r]=createBoard(CANVAS_WIDTH,CANVAS_HEIGHT);clusters=createClusters(r),[players,human]=createPlayers(clusters),drawInit(e,clusters,players,human.id)}function nextTurn(e){e===human&&([listenerDisabled,btn.disabled]=[!1,!1]),e.turn(clusters,players,async()=>{await afterTurn(e)})}function afterTurn(n){return new Promise(e=>{var a,r,s=clusters.map(e=>e.dices);n.allocateNewDices(clusters);for([a,r]of clusters.entries())r.playerId===n.id&&r.dices!==s[a]&&drawDices(r,s[a]);drawDicesNums(n),++playerIndex>=players.length&&(playerIndex=0);let t=players[playerIndex];setTimeout(()=>{drawDicesBar(n.id,t.id),console.log("...finished."),e(t)},t===human?0:TIMEOUT_BG)}).then(e=>nextTurn(e))}function clickListener(e){if(!listenerDisabled){e=human.click({x:e.clientX,y:e.clientY});if(void 0!==e)if(human.afterSuccessfulMove(clusters,players,e))return listenerDisabled=!0,void(btn.disabled=!0);human.clickableClusters=clusters.filter(e=>e.playerId===human.id&&1<e.dices&&e.adjacentClustersFromCluster().some(e=>e.playerId!==human.id))}}main();