import{CANVAS_WIDTH,CANVAS_HEIGHT,CLUSTERS_MAX,TIMEOUT_BG,setPlayers,setColor}from"./info.js";import{createBoard}from"./board.js";import{createClusters}from"./clusters.js";import{createPlayers}from"./players.js";import{drawInit,drawDices,drawDicesNums,drawDicesBar,drawCluster}from"./draw.js";import{Comp}from"./player-comp.js";import{Human}from"./player-human.js";import{Cluster}from"./cluster.js";import{Player}from"./player.js";import Stats from"./stats.js";let canvas,btn,listenerDisabled=!0,clusters,players,human,playerIndex=-1;function main(){init()}function init(){document.getElementById("launch").style.display="block",document.getElementById("btn-launch").addEventListener("click",()=>{for(let e=3;e<=8;e++)if(document.getElementById("p"+e).checked){setPlayers(e);break}let t;for(let e=1;e<=8;e++)if(document.getElementById("c"+e).checked){t=e-1;break}document.getElementById("launch").remove(),document.getElementById("main").style.display="block";var[e,n]=createBoard(CANVAS_WIDTH,CANVAS_HEIGHT);clusters=createClusters(n),[players,human]=createPlayers(clusters),setColor(human.id,t),drawInit(e,clusters,players),Stats.set.startTime(),nextTurn(players[0])}),document.getElementById("main").style.display="none",(btn=document.getElementById("btn-turn")).addEventListener("click",async()=>{listenerDisabled=!0,btn.disabled=!0,void 0!==human.clickedCluster&&drawCluster(human.clickedCluster.corners,human.id),await afterTurn(human)}),btn.disabled=!0;var t=document.getElementById("stage");for(let e=0;e<=CLUSTERS_MAX;e++)(canvas=document.createElement("canvas")).id="canvas-"+e,canvas.width=CANVAS_WIDTH,canvas.height=CANVAS_HEIGHT,t.appendChild(canvas);canvas.addEventListener("click",e=>{if(!listenerDisabled){var t=canvas.getBoundingClientRect(),e=human.click({x:e.clientX-t.left,y:e.clientY-t.top});if(void 0!==e)if(human.afterSuccessfulMove(clusters,players,e))return listenerDisabled=!0,void end(btn.disabled=!0);human.clickableClusters=clusters.filter(e=>e.playerId===human.id&&1<e.dices&&e.adjacentClustersFromCluster().some(e=>e.playerId!==human.id))}},!1),document.getElementById("end").style.display="none",document.getElementById("btn-restart").addEventListener("click",()=>{document.getElementById("end").style.display="none",document.getElementById("main").style.display="block";for(var e=document.getElementsByClassName("dices-player");0<e.length;)e[0].parentNode.removeChild(e[0]);btn.disabled=!0;var[t,n]=createBoard(CANVAS_WIDTH,CANVAS_HEIGHT);Cluster.count=0,clusters=createClusters(n),Player.count=0,[players,human]=createPlayers(clusters),setColor(human.id),drawInit(t,clusters,players),Stats.reset(),playerIndex=-1,nextTurn(players[0])})}function nextTurn(e){e===human&&([listenerDisabled,btn.disabled]=[!1,!1],Stats.set.turns()),e.turn(clusters,players,async()=>{await afterTurn(e)},end)}function afterTurn(r){return new Promise(e=>{var t,n,a=clusters.map(e=>e.dices);r.allocateNewDices(clusters);for([t,n]of clusters.entries())n.playerId===r.id&&n.dices!==a[t]&&drawDices(n,a[t]);drawDicesNums(r),++playerIndex>=players.length&&(playerIndex=0);let s=players[playerIndex];setTimeout(()=>{drawDicesBar(r.id,s.id),console.log("...finished."),e(s)},s===human?0:TIMEOUT_BG)}).then(e=>nextTurn(e))}function end(e){for(var t in document.getElementById("main").style.display="none",document.getElementById("end").style.display="block",document.getElementById("h-end").textContent=e?"You won!":"You lost.",Stats.get)document.getElementById("li-end-"+t).textContent=Stats.get[t]()}main();