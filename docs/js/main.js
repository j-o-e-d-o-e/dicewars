import{CANVAS_WIDTH,CANVAS_HEIGHT,CLUSTERS_MAX,TIMEOUT_BG,setPlayers}from"./info.js";import{createBoard}from"./board.js";import{createClusters}from"./clusters.js";import{createPlayers}from"./players.js";import{loadImages,setColor,setBackgroundCtx,setForegroundCtx,drawInit,drawCluster,drawDices,drawDicesNums,drawDicesBar}from"./draw.js";import Stats from"./stats.js";const[board,centerNode]=createBoard();let btn,listenerDisabled=!0,clusters,players,human,playerIndex=0;function main(){loadImages().then(()=>{init()})}function testDisplay(){init(),createGame(),document.getElementById("launch").style.display="none",document.getElementById("main").style.display="block",document.getElementById("main-before").style.display="none",clusters.forEach(e=>{e.dices=8,drawCluster(e.corners,e.playerId)}),players.forEach(e=>{e.additionalDices=2*CLUSTERS_MAX,drawDicesNums(e)})}function init(){document.getElementById("launch").style.display="block",document.getElementById("btn-launch").addEventListener("click",()=>{for(let e=3;e<=8;e++)if(document.getElementById("p"+e).checked){setPlayers(e);break}let t;for(let e=1;e<=8;e++)if(document.getElementById("c"+e).checked){t=e-1;break}createGame(t),document.getElementById("launch").remove(),document.getElementById("main").style.display="block",document.getElementById("main-before").style.display="block",document.getElementById("main-play").style.display="none"}),document.getElementById("main").style.display="none",document.getElementById("btn-yes").addEventListener("click",()=>{document.getElementById("main-before").style.display="none",document.getElementById("main-play").style.display="block",playerIndex=0,Stats.reset(),nextTurn(players[0])}),document.getElementById("btn-no").addEventListener("click",()=>createGame()),(btn=document.getElementById("btn-turn")).addEventListener("click",async()=>{listenerDisabled=!0,btn.disabled=!0,void 0!==human.clickedCluster&&drawCluster(human.clickedCluster.corners,human.id),await afterTurn(human)}),btn.disabled=!0;let t=document.getElementById("stage"),n;for(let e=0;e<=CLUSTERS_MAX;e++)(n=document.createElement("canvas")).width=CANVAS_WIDTH,n.height=CANVAS_HEIGHT,t.appendChild(n),(0===e?setBackgroundCtx:setForegroundCtx)(n);n.addEventListener("click",async e=>{var t;e.stopPropagation(),listenerDisabled||(t=n.getBoundingClientRect(),void 0!==(e=human.click({x:e.clientX-t.left,y:e.clientY-t.top}))&&human.afterSuccessfulMove(clusters,players,e)&&await end(!0))},!1),document.getElementById("end").style.display="none",document.getElementById("btn-restart").addEventListener("click",()=>{createGame(),document.getElementById("end").style.display="none",document.getElementById("main").style.display="block",document.getElementById("main-before").style.display="block",document.getElementById("main-play").style.display="none"})}function createGame(e=0){clusters=createClusters(centerNode),[players,human]=createPlayers(clusters),setColor(human.id,e),drawInit(board,clusters,players)}function nextTurn(e){e===human&&([listenerDisabled,btn.disabled]=[!1,!1],human.clickableClusters=clusters.filter(e=>e.playerId===human.id&&1<e.dices&&e.adjacentClustersFromCluster().some(e=>e.playerId!==human.id)),Stats.set.rounds()),e.turn(clusters,players,async()=>afterTurn(e),end)}function afterTurn(s){return new Promise(a=>{setTimeout(()=>{var e,t,n=clusters.map(e=>e.dices);s.allocateNewDices(clusters);for([e,t]of clusters.entries())t.playerId===s.id&&t.dices!==n[e]&&drawDices(t,n[e]);drawDicesNums(s),++playerIndex>=players.length&&(playerIndex=0);let l=players[playerIndex];setTimeout(()=>{drawDicesBar(s.id,l.id),console.log("...finished."),a(l)},l.id!==human.id?TIMEOUT_BG:0)},s.id!==human.id?TIMEOUT_BG:0)}).then(e=>nextTurn(e))}function end(n){return new Promise(t=>{listenerDisabled=!0,btn.disabled=!0,setTimeout(()=>{for(var e in document.getElementById("main").style.display="none",document.getElementById("end").style.display="block",document.getElementById("h-end").textContent=n?"You won!":"You lost.",Stats.get)document.getElementById("li-end-"+e).textContent=Stats.get[e]();t()},TIMEOUT_BG)})}main();