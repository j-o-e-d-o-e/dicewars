import{CLUSTER_MIN_SIZE,CLUSTERS_MAX}from"./info.js";class Cluster{constructor(e,t,r){this.id=e,this.playerId=r?r.playerId:void 0,this.dices=r?r.dices:Math.floor(6*Math.random())+1,this.nodes=[],this.addNodeAndItsNeighbours(t),r||this.expand(),this.corners=this.cornersPos(),this.center=this.centerPos(),this.adjacentClusters=void 0}addNodeAndItsNeighbours(e){(e.cluster=this).nodes.push(e),e.adjacentNodesFromNode().filter(e=>void 0===e.cluster).forEach(e=>{(e.cluster=this).nodes.push(e)})}expand(){for(;this.nodes.length<CLUSTER_MIN_SIZE;){var e=this.adjacentNodesFromCluster().filter(e=>void 0===e.cluster);if(0===e.length)break;e=e[Math.floor(Math.random()*(e.length-1))];this.addNodeAndItsNeighbours(e)}}cornersPos(){var e,t=[];for(e of this.nodes)for(var[r,s]of["upRight","upLeft","left","downLeft","downRight","right"].entries())void 0!==e[s]&&e[s]?.cluster?.id===this.id||(r=5==(s=5-r)?0:1+s,t.push({start:{x:e.hex.corners[r].x,y:e.hex.corners[r].y},end:{x:e.hex.corners[s].x,y:e.hex.corners[s].y}}));t.sort((e,t)=>e.start.x-t.start.x);let i=t.shift();for(var d=[i];0!==t.length;)for(let e=0;e<t.length;e++){var a=t[e];if(Math.sqrt((i.end.x-a.start.x)**2+(i.end.y-a.start.y)**2)<2){i=a,t.splice(e,1),d.push(i);break}}return d.map(e=>e.start)}centerPos(){var r=[...this.corners,this.corners[0]];let s,i=0,d=0,a=0;for(let e=0,t=r.length-1;e<r.length;t=e++){var o=r[e],n=r[t];s=o.x*n.y-n.x*o.y,i+=s,d+=(o.x+n.x)*s,a+=(o.y+n.y)*s}return s=3*i,{x:d/s,y:a/s}}adjacentNodesFromCluster(){return Array.from(new Set(this.nodes.flatMap(e=>e.adjacentNodesFromNode()).filter(e=>!this.nodes.includes(e))))}neighbours(){this.adjacentClusters=[...new Set(this.adjacentNodesFromCluster().filter(e=>void 0!==e.cluster).map(e=>e.cluster))]}adjacentClustersFromCluster(){return this.adjacentClusters}containsPoint(r){var s=this.corners;let i=!1;for(let e=0,t=s.length-1;e<s.length;e++)s[e].y>r.y!=s[t].y>r.y&&r.x<(s[t].x-s[e].x)*(r.y-s[e].y)/(s[t].y-s[e].y)+s[e].x&&(i=!i),t=e;return i}region(){let t=[this],e=this.adjacentClustersFromCluster().filter(e=>e.playerId===this.playerId);for(;0<e.length;)t=t.concat(e),e=[...new Set(e.flatMap(e=>e.adjacentClustersFromCluster().filter(e=>!t.includes(e)&&e.playerId===this.playerId)))];return t}path(r){let s;var e=[this],t=Array(CLUSTERS_MAX).fill(!1),i=(t[this.id]=!0,Array(CLUSTERS_MAX)),d=Array(CLUSTERS_MAX);for(d[this.id]=0;0<e.length;){var a,o=e.shift();for(a of o.adjacentClustersFromCluster()){var n=this.dices-d[o.id];if(!(a.id!==r.id&&a.playerId===this.playerId||a.playerId!==r.playerId&&a.dices-(8==n)>=n||t[a.id]))if(i[a.id]=o,d[a.id]=d[o.id]+1,a.id!==r.id)t[a.id]=!0,e.push(a);else{let e=r,t=i[e.id];for(var h,l=[e];t;)l.push(t),t=i[t.id];l.reverse(),(!s||(n=Math.min(...l.slice(1,-1).map((e,t)=>this.dices-t-e.dices)),(h=Math.min(...s.slice(1,-1).map((e,t)=>this.dices-t-e.dices)))<n)||n===h&&l.length<s.length)&&(s=l)}}}return s}}export{Cluster};