import{CLUSTER_MIN_SIZE,CLUSTERS_MAX}from"./info.js";class Cluster{static count=0;constructor(e,t){this.id=t?t.id:Cluster.count++,this.playerId=t?t.playerId:void 0,this.dices=t?t.dices:Math.floor(6*Math.random())+1,this.nodes=[],this.addNodeAndItsNeighbours(e),t||this.expand(),this.centerPos=this.centerPos(),this.corners=this.cornersPos(),this.adjacentClusters=void 0}addNodeAndItsNeighbours(e){(e.cluster=this).nodes.push(e),e.adjacentNodesFromNode().filter(e=>void 0===e.cluster).forEach(e=>{(e.cluster=this).nodes.push(e)})}expand(){for(;this.nodes.length<CLUSTER_MIN_SIZE;){var e=this.adjacentNodesFromCluster().filter(e=>void 0===e.cluster);if(0===e.length)break;e=e[Math.floor(Math.random()*(e.length-1))];this.addNodeAndItsNeighbours(e)}}centerPos(){let e=this.nodes.find(e=>{e=e.adjacentNodesFromNode();return 6===e.length&&e.every(e=>e.cluster?.id===this.id)});return(e=void 0===e?this.nodes[0]:e).hex.center}cornersPos(){var e,t=[];for(e of this.nodes)for(var[r,s]of["upRight","upLeft","left","downLeft","downRight","right"].entries())void 0!==e[s]&&e[s]?.cluster?.id===this.id||(r=5==(s=5-r)?0:1+s,t.push({start:{x:e.hex.corners[r].x,y:e.hex.corners[r].y},end:{x:e.hex.corners[s].x,y:e.hex.corners[s].y}}));t.sort((e,t)=>e.start.x-t.start.x);let i=t.shift();for(var d=[i];0!==t.length;)for(let e=0;e<t.length;e++){var o=t[e];if(Math.sqrt((i.end.x-o.start.x)**2+(i.end.y-o.start.y)**2)<2){i=o,t.splice(e,1),d.push(i);break}}return d.map(e=>e.start)}adjacentNodesFromCluster(){return Array.from(new Set(this.nodes.flatMap(e=>e.adjacentNodesFromNode()).filter(e=>!this.nodes.includes(e))))}neighbours(){this.adjacentClusters=[...new Set(this.adjacentNodesFromCluster().filter(e=>void 0!==e.cluster).map(e=>e.cluster))]}adjacentClustersFromCluster(){return this.adjacentClusters}containsPoint(r){var s=this.corners;let i=!1;for(let e=0,t=s.length-1;e<s.length;e++)s[e].y>r.y!=s[t].y>r.y&&r.x<(s[t].x-s[e].x)*(r.y-s[e].y)/(s[t].y-s[e].y)+s[e].x&&(i=!i),t=e;return i}region(){let t=[this],e=this.adjacentClustersFromCluster().filter(e=>e.playerId===this.playerId);for(;0<e.length;)t=t.concat(e),e=[...new Set(e.flatMap(e=>e.adjacentClustersFromCluster().filter(e=>!t.includes(e)&&e.playerId===this.playerId)))];return t}path(r){let s;var e=[this],t=Array(CLUSTERS_MAX).fill(!1),i=(t[this.id]=!0,Array(CLUSTERS_MAX)),d=Array(CLUSTERS_MAX);for(d[this.id]=0;0<e.length;){var o,a=e.shift();for(o of a.adjacentClustersFromCluster())if(!(o.id!==r.id&&o.playerId===this.playerId||o.playerId!==r.playerId&&o.dices>=this.dices-d[a.id]||t[o.id]))if(i[o.id]=a,d[o.id]=d[a.id]+1,o.id!==r.id)t[o.id]=!0,e.push(o);else{let e=r,t=i[e.id];for(var n,h,l=[e];t;)l.push(t),t=i[t.id];l.reverse(),(!s||(n=Math.min(...l.slice(1,-1).map((e,t)=>this.dices-t-e.dices)),(h=Math.min(...s.slice(1,-1).map((e,t)=>this.dices-t-e.dices)))<n)||n===h&&l.length<s.length)&&(s=l)}}return s}}export{Cluster};