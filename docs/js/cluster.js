import{CLUSTER_MIN_SIZE,CLUSTERS_MAX}from"./info.js";class Cluster{constructor(t,e,r){this.id=t,this.playerId=r?r.playerId:void 0,this.dices=r?r.dices:Math.floor(6*Math.random())+1,this.nodes=[],this.addNodeAndItsNeighbours(e),r||this.expand(),this.corners=this.cornersPos(),this.center=this.centerPos(),this.adjacentClusters=void 0}addNodeAndItsNeighbours(t){(t.cluster=this).nodes.push(t),t.adjacentNodesFromNode().filter(t=>void 0===t.cluster).forEach(t=>{(t.cluster=this).nodes.push(t)})}expand(){for(;this.nodes.length<CLUSTER_MIN_SIZE;){var t=this.adjacentNodesFromCluster().filter(t=>void 0===t.cluster);if(0===t.length)break;t=t[Math.floor(Math.random()*(t.length-1))];this.addNodeAndItsNeighbours(t)}}cornersPos(){var t,e=[];for(t of this.nodes)for(var[r,s]of["upRight","upLeft","left","downLeft","downRight","right"].entries())void 0!==t[s]&&t[s]?.cluster?.id===this.id||(r=5==(s=5-r)?0:1+s,e.push({start:{x:t.hex.corners[r].x,y:t.hex.corners[r].y},end:{x:t.hex.corners[s].x,y:t.hex.corners[s].y}}));e.sort((t,e)=>t.start.x-e.start.x);let i=e.shift();for(var o=[i];0!==e.length;)for(let t=0;t<e.length;t++){var d=e[t];if(Math.sqrt((i.end.x-d.start.x)**2+(i.end.y-d.start.y)**2)<2){i=d,e.splice(t,1),o.push(i);break}}return o.map(t=>({x:Math.floor(t.start.x),y:t.start.y}))}centerPos(){var r=[...this.corners,this.corners[0]];let s,i=0,o=0,d=0;for(let t=0,e=r.length-1;t<r.length;e=t++){var a=r[t],h=r[e];s=a.x*h.y-h.x*a.y,i+=s,o+=(a.x+h.x)*s,d+=(a.y+h.y)*s}return s=3*i,{x:Math.floor(o/s),y:Math.floor(d/s)}}adjacentNodesFromCluster(){return Array.from(new Set(this.nodes.flatMap(t=>t.adjacentNodesFromNode()).filter(t=>!this.nodes.includes(t))))}neighbours(){this.adjacentClusters=[...new Set(this.adjacentNodesFromCluster().filter(t=>void 0!==t.cluster).map(t=>t.cluster))]}adjacentClustersFromCluster(){return this.adjacentClusters}containsPoint(r){var s=this.corners;let i=!1;for(let t=0,e=s.length-1;t<s.length;t++)s[t].y>r.y!=s[e].y>r.y&&r.x<(s[e].x-s[t].x)*(r.y-s[t].y)/(s[e].y-s[t].y)+s[t].x&&(i=!i),e=t;return i}region(){let e=[this],t=this.adjacentClustersFromCluster().filter(t=>t.playerId===this.playerId);for(;0<t.length;)e=e.concat(t),t=[...new Set(t.flatMap(t=>t.adjacentClustersFromCluster().filter(t=>!e.includes(t)&&t.playerId===this.playerId)))];return e}path(r){let s;var t=[this],e=Array(CLUSTERS_MAX).fill(!1),i=(e[this.id]=!0,Array(CLUSTERS_MAX)),o=Array(CLUSTERS_MAX);for(o[this.id]=0;0<t.length;){var d,a=t.shift();for(d of a.adjacentClustersFromCluster()){var h=this.dices-o[a.id];if(!(d.id!==r.id&&d.playerId===this.playerId||d.playerId!==r.playerId&&d.dices-(8==h)>=h||e[d.id]))if(i[d.id]=a,o[d.id]=o[a.id]+1,d.id!==r.id)e[d.id]=!0,t.push(d);else{let t=r,e=i[t.id];for(var n,l=[t];e;)l.push(e),e=i[e.id];l.reverse(),(!s||(h=Math.min(...l.slice(1,-1).map((t,e)=>this.dices-e-t.dices)),(n=Math.min(...s.slice(1,-1).map((t,e)=>this.dices-e-t.dices)))<h)||h===n&&l.length<s.length)&&(s=l)}}}return s}}export{Cluster};